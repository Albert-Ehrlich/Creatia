{% extends "base.html" %}
{% block title %}Chat{% endblock %}
{% block content %}
{% set user_list = users | map(attribute='id') | list %}
{% set users_payload = users | map(attribute='__dict__') %}
<div class="content-wrapper chat-page">
  <section class="content-header">
    <div class="page-header">
      <div>
        <h1>Chat</h1>
        <p class="page-subtitle">Group chat and private messages</p>
      </div>
      <div class="header-actions">
        <a
          href="{{ url_for('admin_dashboard') if user.role == 'admin' else (url_for('supervisor_dashboard') if user.role == 'supervisor' else url_for('researcher_dashboard')) }}"
          class="btn-mail"
        >
          Back to dashboard
        </a>
        <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
      </div>
    </div>
  </section>

  <section class="content chat-layout">
    <aside class="chat-sidebar">
      <div class="chat-section-title">Channels</div>
      <button class="chat-target active" data-target="group">
        <span class="chat-target__title">گپ گروهی</span>
        <small class="chat-target__subtitle">همه کاربران</small>
        <span class="chat-badge" data-badge="group" hidden>0</span>
      </button>
      <div class="chat-section-title">پیام خصوصی</div>
      <div class="chat-list">
        {% for u in users %}
        <button class="chat-target" data-target="{{ u.id }}">
          <span class="chat-target__title">{{ u.full_name or u.username }}</span>
          <small class="chat-target__subtitle">@{{ u.username }}</small>
          <span class="chat-badge" data-badge="{{ u.id }}" hidden>0</span>
        </button>
        {% endfor %}
      </div>
    </aside>

    <div class="chat-main">
      <div class="chat-main__header">
        <div>
          <div class="chat-title" data-chat-title>گپ گروهی</div>
          <div class="chat-subtitle" data-chat-subtitle>همه کاربران</div>
        </div>
      </div>
      <div class="chat-messages" data-chat-messages>
        <p class="chat-empty">پیامی ثبت نشده است.</p>
      </div>
      <form id="chatForm" class="chat-form">
        <input type="hidden" name="target" value="group" />
        <textarea
          name="body"
          rows="2"
          placeholder="پیام خود را بنویسید..."
          required
          maxlength="2000"
        ></textarea>
        <button type="submit" class="btn-mail">ارسال</button>
      </form>
    </div>
  </section>
</div>

<script>
  (() => {
    const currentUser = {
      id: {{ user.id }},
      name: {{ (user.full_name or user.username)|tojson }}
    };
    const users = {{ users | map(attribute='id') | list | tojson }};
    const userLookup = {};
    {% for u in users %}
      userLookup[{{ u.id }}] = {{ (u.full_name or u.username)|tojson }};
    {% endfor %}

    const targetButtons = document.querySelectorAll(".chat-target");
    const messagesBox = document.querySelector("[data-chat-messages]");
    const titleEl = document.querySelector("[data-chat-title]");
    const subtitleEl = document.querySelector("[data-chat-subtitle]");
    const form = document.getElementById("chatForm");
    const textarea = form?.querySelector("textarea[name='body']");
    const groupBadge = document.querySelector("[data-badge='group']");
    const privateBadges = document.querySelectorAll("[data-badge]");

    let currentTarget = "group";
    let lastId = null;
    let poller = null;

    const labelFor = (target) => {
      if (target === "group") {
        return { title: "گپ گروهی", subtitle: "همه کاربران" };
      }
      const name = userLookup[target] || "کاربر";
      return { title: `گفتگو با ${name}`, subtitle: "پیام خصوصی" };
    };

    const renderMessages = (msgs, append = false) => {
      if (!messagesBox) return;
      if (!append) messagesBox.innerHTML = "";
      if (!msgs.length && !append) {
        messagesBox.innerHTML = '<p class="chat-empty">پیامی ثبت نشده است.</p>';
        return;
      }
      if (append && msgs.length) {
        messagesBox
          .querySelectorAll(".chat-empty")
          .forEach((n) => n.remove());
      }
      msgs.forEach((m) => {
        const item = document.createElement("div");
        item.className = `chat-msg${m.is_mine ? " chat-msg--mine" : ""}`;
        const author = document.createElement("div");
        author.className = "chat-msg__meta";
        author.textContent = m.is_mine ? "شما" : m.sender_name || "کاربر";
        const body = document.createElement("div");
        body.className = "chat-msg__body";
        body.textContent = m.body;
        item.append(author, body);
        if (m.can_delete) {
          const actions = document.createElement("div");
          actions.className = "chat-msg__actions";
          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "chat-msg__delete";
          delBtn.textContent = "حذف";
          delBtn.addEventListener("click", async () => {
            const ok = confirm("این پیام حذف شود؟");
            if (!ok) return;
            await deleteMessage(m.id);
          });
          actions.appendChild(delBtn);
          item.appendChild(actions);
        }
        messagesBox.appendChild(item);
      });
      messagesBox.scrollTop = messagesBox.scrollHeight;
    };

    const loadMessages = async (initial = false) => {
      const url = new URL("/api/chat/messages", window.location.origin);
      url.searchParams.set("target", currentTarget);
      if (lastId) url.searchParams.set("after", lastId);
      url.searchParams.set("mark_read", "1");
      try {
        const res = await fetch(url.toString(), { cache: "no-cache" });
        if (!res.ok) return;
        const data = await res.json();
        if (data.length) {
          lastId = data[data.length - 1].id;
          renderMessages(data, true);
        } else if (initial) {
          renderMessages([], false);
        }
        await refreshUnread();
      } catch (err) {
        console.warn("Chat load failed", err);
      }
    };

    const resetAndLoad = () => {
      lastId = null;
      renderMessages([], false);
      loadMessages(true);
      if (poller) clearInterval(poller);
      poller = setInterval(() => loadMessages(false), 5000);
    };

    const refreshUnread = async () => {
      try {
        const res = await fetch("/api/chat/unread", { cache: "no-cache" });
        if (!res.ok) return;
        const data = await res.json();
        if (groupBadge) {
          const g = Number(data.group) || 0;
          groupBadge.textContent = g;
          groupBadge.hidden = g <= 0;
        }
        privateBadges.forEach((b) => {
          const peer = b.dataset.badge;
          const rawVal =
            peer === "group"
              ? data.group
              : (data.privates || {})[peer];
          const num = Number(rawVal) || 0;
          b.textContent = num;
          b.hidden = num <= 0;
        });
      } catch (err) {
        /* ignore */
      }
    };

    const deleteMessage = async (id) => {
      try {
        const res = await fetch(`/api/chat/messages/${id}`, {
          method: "DELETE",
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          alert(data.error || "امکان حذف پیام نیست.");
          return;
        }
        await refreshUnread();
        resetAndLoad();
      } catch (err) {
        alert("حذف پیام انجام نشد.");
      }
    };

    const activateTarget = (target) => {
      const btn = document.querySelector(`.chat-target[data-target="${target}"]`);
      if (!btn) return false;
      targetButtons.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      currentTarget = target;
      const labels = labelFor(target);
      if (titleEl) titleEl.textContent = labels.title;
      if (subtitleEl) subtitleEl.textContent = labels.subtitle;
      form.querySelector('input[name="target"]').value = target;
      resetAndLoad();
      return true;
    };

    targetButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.target || "group";
        if (target === currentTarget) return;
        activateTarget(target);
      });
    });

    const params = new URLSearchParams(window.location.search);
    const initialTarget = params.get("target");
    const activated =
      initialTarget && initialTarget !== "group" ? activateTarget(initialTarget) : false;
    if (!activated) {
      resetAndLoad();
    }

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!textarea || !textarea.value.trim()) return;
      const body = textarea.value.trim();
      try {
        const res = await fetch("/api/chat/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ target: currentTarget, body }),
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          alert(data.error || "ارسال پیام با خطا مواجه شد.");
          return;
        }
        const msg = await res.json();
        textarea.value = "";
        lastId = msg.id;
        renderMessages([msg], true);
        await refreshUnread();
      } catch (err) {
        alert("ارتباط با سرور برقرار نشد.");
      }
    });

    textarea?.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form?.requestSubmit?.();
      }
    });

    refreshUnread().then(resetAndLoad);
  })();
</script>
{% endblock %}
