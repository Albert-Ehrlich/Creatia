{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}
{% block content %}
<div class="content-wrapper admin-dashboard-page">
  <section class="content-header">
    <div class="page-header">
      <div>
        <h1>User Management</h1>
        <p class="page-subtitle">Create users and custom groups</p>
      </div>
      <div class="header-actions">
        <a href="{{ url_for('admin_dashboard') }}" class="btn-mail">Back to Dashboard</a>
        <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
      </div>
    </div>
  </section>

  <section class="content">
    <div class="dashboard-card dual-calendar-card full-row-card">
      <h3>Create Group</h3>
      <form id="createGroupForm" class="stacked-form manage-form">
        <input type="text" name="name" placeholder="Group name" required />
        <label class="compact-label">Attach existing roles</label>
        <select name="roles" id="groupRoles" multiple>
          {% for r in roles %}
          <option value="{{ r.name }}">{{ r.name }}</option>
          {% endfor %}
        </select>
        <input type="text" name="new_role" placeholder="Define new role (optional)" />
        <textarea name="permissions" rows="3" placeholder='Notes/permissions (optional)'></textarea>
        <button type="submit" class="submit-btn">Save Group</button>
      </form>
    </div>

    <div class="dashboard-card dual-calendar-card full-row-card">
      <h3>Create User</h3>
      <form id="createUserForm" class="stacked-form manage-form">
        <div class="form-grid">
          <input type="text" name="username" placeholder="Username" required />
          <input type="email" name="email" placeholder="Email" required />
          <input type="password" name="password" placeholder="Password" required />
          <select name="role" required>
            {% for r in roles %}
            <option value="{{ r.name }}" {% if r.name=='researcher' %}selected{% endif %}>{{ r.name }}</option>
            {% endfor %}
          </select>
        </div>
        <label class="compact-label checkbox-inline"><input type="checkbox" id="showCreatePassword" /> Show password</label>
        <button type="submit" class="submit-btn">Create User</button>
      </form>
    </div>

    <div class="dashboard-card dual-calendar-card full-row-card">
      <h3>Existing Users</h3>
      <div class="mailbox__list manage-users__list">
        {% for u in users %}
        <div class="task-row slim">
          <div class="task-row__meta">
            <span class="task-row__title">{{ u.username }}</span>
            <span class="task-row__date">{{ u.email }}</span>
          </div>
          <div class="task-row__actions">
            <span class="task-row__assignee">Role: {{ u.role }}</span>
            <button class="btn-logout submit-btn--small" data-delete-user="{{ u.id }}">Delete</button>
            <button class="submit-btn submit-btn--small"
              data-edit-user="{{ u.id }}"
              data-username="{{ u.username }}"
              data-email="{{ u.email }}"
              data-role="{{ u.role }}"
              data-active="{{ u.is_active }}"
            >Edit</button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const groupForm = document.getElementById("createGroupForm");
    const userForm = document.getElementById("createUserForm");

    groupForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(groupForm);
      const roles = Array.from(document.getElementById("groupRoles")?.selectedOptions || []).map((o) => o.value);
      const newRole = (fd.get("new_role") || "").trim();
      if (newRole) roles.push(newRole);
      const payload = {
        name: fd.get("name"),
        permissions: JSON.stringify({ roles, note: fd.get("permissions") || "" }),
      };
      const res = await fetch("/api/roles", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        alert("Could not create group");
      } else {
        location.reload();
      }
    });

    userForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(userForm);
      const payload = {
        username: fd.get("username"),
        email: fd.get("email"),
        password: fd.get("password"),
        role: fd.get("role"),
      };
      const res = await fetch("/api/admin/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        alert("Could not create user");
      } else {
        location.reload();
      }
    });

    const passwordInput = userForm?.querySelector('input[name="password"]');
    const showPw = document.getElementById("showCreatePassword");
    showPw?.addEventListener('change', () => {
      if (passwordInput) passwordInput.type = showPw.checked ? 'text' : 'password';
    });

    const openEditModal = (user) => {
      const overlay = document.createElement('div');
      overlay.className = 'manage-modal';
      const dialog = document.createElement('div');
      dialog.className = 'manage-modal__card';
      dialog.innerHTML = `
        <h3>Edit User</h3>
        <form class="stacked-form manage-form" id="editUserForm">
          <input type="text" name="username" value="${user.username}" required />
          <input type="email" name="email" value="${user.email}" required />
          <input type="password" name="password" placeholder="New password (optional)" />
          <label class="compact-label checkbox-inline"><input type="checkbox" id="editShowPw"> Show password</label>
          <select name="role">
            {% for r in roles %}
            <option value="{{ r.name }}">{{ r.name }}</option>
            {% endfor %}
          </select>
          <label class="compact-label checkbox-inline"><input type="checkbox" name="is_active" ${user.is_active ? 'checked' : ''}> Active</label>
          <div class="manage-modal__actions">
            <button type="submit" class="submit-btn">Save</button>
            <button type="button" class="ghost-btn" id="editCancel">Cancel</button>
          </div>
        </form>
      `;
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      const form = dialog.querySelector('#editUserForm');
      const select = form.querySelector('select[name="role"]');
      select.value = user.role;
      const pwInput = form.querySelector('input[name="password"]');
      const show = form.querySelector('#editShowPw');
      show?.addEventListener('change', ()=>{ if (pwInput) pwInput.type = show.checked ? 'text' : 'password'; });
      dialog.querySelector('#editCancel')?.addEventListener('click', ()=> overlay.remove());
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const payload = {
          username: fd.get('username'),
          email: fd.get('email'),
          role: fd.get('role'),
          is_active: form.querySelector('input[name="is_active"]').checked,
        };
        const pw = fd.get('password');
        if (pw) payload.password = pw;
        const res = await fetch(`/api/admin/users/${user.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert('Could not update user');
        } else {
          location.reload();
        }
      });
    };

    document.querySelectorAll('[data-edit-user]')?.forEach((btn) => {
      btn.addEventListener('click', () => {
        const user = {
          id: btn.dataset.editUser,
          username: btn.dataset.username,
          email: btn.dataset.email,
          role: btn.dataset.role,
          is_active: btn.dataset.active === 'True' || btn.dataset.active === 'true' || btn.dataset.active === '1'
        };
        openEditModal(user);
      });
    });

    document.querySelectorAll('[data-delete-user]')?.forEach((btn) => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.deleteUser;
        if (!confirm('Are you sure you want to delete this user?')) return;
        const res = await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
        if (!res.ok) {
          alert('Could not delete user');
        } else {
          location.reload();
        }
      });
    });
  });
</script>
{% endblock %}
