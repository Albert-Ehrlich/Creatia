{% extends "base.html" %}
{% block content %}
<div class="content-wrapper">
  <section class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
      <div>
        <h1>Admin Dashboard</h1>
        <p style="margin: 5px 0 0 0; color: #999; font-size: 0.9rem;">System Administration & Management</p>
      </div>
      <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
    </div>
  </section>

  <!-- Welcome Card -->
  <section class="content">
    <div class="dashboard-card welcome-card" id="welcomeCard">
      <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 250px;">
          <h2>Welcome, Admin {{ user.username }}! üëë</h2>
          <p style="color: #666; margin: 10px 0 0 0;">You have full access to system administration tools and user management.</p>
        </div>
        <div class="admin-stats">
          <div class="stat-box">
            <div class="stat-number">2</div>
            <div class="stat-label">Total Users</div>
          </div>
          <div class="stat-box">
            <div class="stat-number">1</div>
            <div class="stat-label">Admin Users</div>
          </div>
        </div>
      </div>
      
      <div class="user-info" style="margin-top: 20px;">
        <p><strong>Email:</strong> {{ user.email }}</p>
        <p><strong>Role:</strong> <span class="role-badge admin">Administrator</span></p>
        <p><strong>Member Since:</strong> {{ user.created_at.strftime('%B %d, %Y') }}</p>
        {% if user.last_login %}
          <p><strong>Last Login:</strong> {{ user.last_login.strftime('%B %d, %Y at %I:%M %p') }}</p>
        {% endif %}
      </div>
    </div>

    <!-- Management Tools -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
      <div class="dashboard-card">
        <h3>üë• Manage Users</h3>
        <p>View, edit, and manage user accounts. Change roles, activate/deactivate users, and monitor user activity.</p>
        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 0.9rem;">
          <strong>Current Users:</strong>
          <ul style="margin: 8px 0 0 0; padding-left: 20px;">
            <li>Mostafa (Admin)</li>
            <li>test (User)</li>
          </ul>
        </div>
        <a href="#" class="btn-action">Manage Users</a>
      </div>

      <div class="dashboard-card">
        <h3>üìä Manage Projects</h3>
        <p>Create, organize, and oversee all projects. Set project goals, assign teams, and monitor progress.</p>
        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 0.9rem;">
          <strong>Status:</strong> 0 projects created
        </div>
        <a href="#" class="btn-action">Manage Projects</a>
      </div>

      <div class="dashboard-card">
        <h3>‚úÖ Manage Tasks</h3>
        <p>Assign tasks, set deadlines, and track completion. Monitor task status across all projects.</p>
        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 0.9rem;">
          <strong>Status:</strong> 0 tasks assigned
        </div>
        <a href="#" class="btn-action">Manage Tasks</a>
      </div>

      <div class="dashboard-card">
        <h3>üìà System Reports</h3>
        <p>View analytics, system performance, and user engagement metrics. Export reports for analysis.</p>
        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 0.9rem;">
          <strong>Latest:</strong> System running smoothly
        </div>
        <a href="#" class="btn-action">View Reports</a>
      </div>

      <div class="dashboard-card">
        <h3>‚öôÔ∏è System Settings</h3>
        <p>Configure system preferences, security settings, and application features. Manage API keys and integrations.</p>
        <a href="#" class="btn-action">System Settings</a>
      </div>

      <div class="dashboard-card">
        <h3>üîç Activity Log</h3>
        <p>Monitor all user activities, login attempts, and system events for security and auditing purposes.</p>
        <a href="#" class="btn-action">View Activity Log</a>
      </div>
    </div>

    <!-- Persian Calendar for Task Assignment -->
    <div class="dashboard-card calendar-card" style="margin-top: 30px;">
      <h3>üìÖ Persian Calendar & Task Assignment</h3>
      <p style="color: #666; margin-bottom: 15px;">Assign tasks to users on the Persian calendar</p>
      
      <div class="persian-calendar-wrapper">
        <div class="calendar-header">
          <button class="calendar-nav-btn" id="prevMonth">&laquo;</button>
          <h4 id="currentMonth"></h4>
          <button class="calendar-nav-btn" id="nextMonth">&raquo;</button>
        </div>
        <div class="calendar-weekdays">
          <div class="weekday">Sha</div>
          <div class="weekday">Yek</div>
          <div class="weekday">Dos</div>
          <div class="weekday">Ses</div>
          <div class="weekday">Cha</div>
          <div class="weekday">Pan</div>
          <div class="weekday">Jom</div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>

      <div class="task-input-section">
        <h4 style="margin-top: 25px; color: rgb(5, 99, 187);">Assign Task to Users</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
          <input type="text" id="taskInput" placeholder="Task description..." class="task-input">
          <select id="userSelect" class="task-input" style="padding: 10px 12px;">
            <option value="">Select User</option>
            <option value="all">All Users</option>
            <option value="Mostafa">Mostafa (Admin)</option>
            <option value="test">test (User)</option>
          </select>
        </div>
        <button id="addTaskBtn" class="btn-action">Assign Task</button>
        <div id="selectedDateDisplay" style="margin-top: 10px; color: #666; font-size: 0.9rem;"></div>
      </div>

      <div class="tasks-list">
        <h4 style="color: rgb(5, 99, 187); margin-top: 20px;">Assigned Tasks</h4>
        <div id="tasksList" style="margin-top: 15px;"></div>
      </div>
    </div>
  </section>
</div>

<style>
.content-wrapper {
  padding: 30px;
  max-width: 1400px;
  margin: 0 auto;
}

.content-header {
  margin-bottom: 40px;
}

.content-header h1 {
  color: rgb(69, 80, 91);
  font-size: 2.5rem;
  margin: 0;
}

.content-header p {
  margin: 0;
}

.content {
  display: grid;
  gap: 30px;
}

.dashboard-card {
  background: white;
  border-radius: 12px;
  padding: 30px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  border-left: 4px solid rgb(5, 99, 187);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.dashboard-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 35px rgba(0, 0, 0, 0.12);
}

.welcome-card {
  border-left-color: #00c410;
  background: linear-gradient(135deg, rgba(0,196,16,0.02), rgba(0,124,114,0.02));
}

.dashboard-card h2 {
  color: rgb(69, 80, 91);
  margin-top: 0;
  margin-bottom: 10px;
  font-size: 1.8rem;
}

.dashboard-card h3 {
  color: rgb(5, 99, 187);
  margin-top: 0;
  font-size: 1.2rem;
}

.admin-stats {
  display: flex;
  gap: 15px;
}

.stat-box {
  background: linear-gradient(135deg, #007c72, #00c410);
  color: white;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  min-width: 120px;
}

.stat-number {
  font-size: 2rem;
  font-weight: 900;
}

.stat-label {
  font-size: 0.85rem;
  opacity: 0.9;
  margin-top: 5px;
}

.user-info {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
}

.user-info p {
  margin: 10px 0;
  color: rgb(45, 55, 75);
  line-height: 1.6;
}

.role-badge {
  display: inline-block;
  background: linear-gradient(139deg, #ff6b6b, #ee5a6f);
  color: white;
  padding: 6px 14px;
  border-radius: 20px;
  font-weight: 700;
  font-size: 0.85rem;
}

.btn-action {
  display: inline-block;
  background: linear-gradient(139deg, #007c72, #00c410);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  margin-top: 15px;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.btn-action:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 124, 114, 0.3);
}

.btn-logout {
  display: inline-block;
  background: linear-gradient(139deg, #dc3545, #c82333);
  color: white;
  padding: 10px 24px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.3s ease;
  border: none;
  cursor: pointer;
}

.btn-logout:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
}

@media (max-width: 768px) {
  .content-header h1 {
    font-size: 1.8rem;
  }
  
  .admin-stats {
    flex-direction: column;
  }
  
  .dashboard-card {
    padding: 20px;
  }
}

/* Welcome Card Fade-out Animation */
@keyframes fadeOut {
  from {
    opacity: 1;
    visibility: visible;
  }
  to {
    opacity: 0;
    visibility: hidden;
  }
}

#welcomeCard.fade-out {
  animation: fadeOut 1s ease-in-out forwards;
}

/* Persian Calendar Styles */
.persian-calendar-wrapper {
  background: linear-gradient(135deg, rgba(0,196,16,0.05), rgba(0,124,114,0.05));
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.calendar-header h4 {
  margin: 0;
  color: rgb(69, 80, 91);
  font-size: 1.1rem;
  min-width: 200px;
  text-align: center;
}

.calendar-nav-btn {
  background: rgb(5, 99, 187);
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
  transition: all 0.2s ease;
}

.calendar-nav-btn:hover {
  background: rgb(3, 75, 150);
  transform: translateY(-2px);
}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-bottom: 10px;
}

.weekday {
  text-align: center;
  font-weight: 700;
  color: rgb(5, 99, 187);
  font-size: 0.8rem;
  padding: 8px 4px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  cursor: pointer;
  background: white;
  border: 1px solid #e0e4e8;
  font-weight: 500;
  color: rgb(45, 55, 75);
  transition: all 0.2s ease;
}

.calendar-day:hover {
  border-color: rgb(5, 99, 187);
  background: rgba(5, 99, 187, 0.05);
}

.calendar-day.other-month {
  color: #ccc;
  background: #f8f9fa;
}

.calendar-day.selected {
  background: rgb(5, 99, 187);
  color: white;
  border-color: rgb(5, 99, 187);
  font-weight: 700;
}

.calendar-day.today {
  border: 2px solid rgb(0, 196, 16);
}

.calendar-day.has-task {
  position: relative;
}

.calendar-day.has-task::after {
  content: '';
  position: absolute;
  bottom: 4px;
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: rgb(0, 196, 16);
}

.task-input-section {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
}

.task-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #e0e4e8;
  border-radius: 6px;
  font-size: 0.9rem;
  margin-bottom: 10px;
  box-sizing: border-box;
}

.task-input:focus {
  outline: none;
  border-color: rgb(5, 99, 187);
  box-shadow: 0 0 0 3px rgba(5, 99, 187, 0.1);
}

.tasks-list {
  max-height: 400px;
  overflow-y: auto;
}

.task-item {
  background: white;
  padding: 12px 15px;
  border-left: 3px solid rgb(5, 99, 187);
  border-radius: 6px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s ease;
}

.task-item:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.task-item.completed {
  opacity: 0.6;
  border-left-color: rgb(0, 196, 16);
}

.task-item.completed .task-text {
  text-decoration: line-through;
  color: #999;
}

.task-text {
  flex: 1;
  color: rgb(45, 55, 75);
  font-size: 0.9rem;
}

.task-date {
  font-size: 0.8rem;
  color: #999;
  margin: 0 10px;
}

.task-user {
  font-size: 0.8rem;
  color: #999;
  margin: 0 10px;
  font-style: italic;
}

.task-actions {
  display: flex;
  gap: 8px;
}

.task-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 0.9rem;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.task-btn.delete {
  color: #dc3545;
}

.task-btn.delete:hover {
  background: rgba(220, 53, 69, 0.1);
}

.task-btn.toggle {
  color: rgb(0, 196, 16);
}

.task-btn.toggle:hover {
  background: rgba(0, 196, 16, 0.1);
}

.calendar-card {
  grid-column: 1 / -1;
}
</style>

<script>
// Persian Calendar Implementation
class PersianCalendarAdmin {
  constructor() {
    this.tasks = JSON.parse(localStorage.getItem('adminTasks')) || {};
    this.selectedDate = null;
    this.currentDate = this.getCurrentPersianDate();
    this.init();
  }

  init() {
    this.renderCalendar();
    this.setupEventListeners();
    this.renderTasksList();
    this.fadeOutWelcome();
  }

  fadeOutWelcome() {
    const welcomeCard = document.getElementById('welcomeCard');
    if (welcomeCard) {
      setTimeout(() => {
        welcomeCard.classList.add('fade-out');
      }, 10000); // 10 seconds
    }
  }

  getCurrentPersianDate() {
    const gregorianDate = new Date();
    return this.gregorianToPersian(gregorianDate);
  }

  gregorianToPersian(gd) {
    const g_d_n = gd.getDate();
    const g_m_n = gd.getMonth() + 1;
    const g_y_n = gd.getFullYear();

    let g_day_no = 365 * g_y_n + (g_y_n + 3) / 4 - (g_y_n + 99) / 100 + (g_y_n + 399) / 400;
    for (let i = 0; i < g_m_n - 1; i++) {
      g_day_no += [0, 31, 28 + (g_y_n % 4 === 0 ? 1 : 0), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][i];
    }
    g_day_no += g_d_n;

    let j_day_no = g_day_no - 79;
    let j_np = Math.floor(j_day_no / 12053);
    j_day_no %= 12053;

    let j_y = 979 + 33 * j_np + 4 * Math.floor(j_day_no / 1461);
    j_day_no %= 1461;

    if (j_day_no >= 366) {
      j_y += Math.floor((j_day_no - 1) / 365);
      j_day_no = (j_day_no - 1) % 365;
    }

    let j_m = j_day_no < 186 ? 1 + Math.floor(j_day_no / 31) : 7 + Math.floor((j_day_no - 186) / 30);
    let j_d = 1 + (j_day_no < 186 ? j_day_no % 31 : (j_day_no - 186) % 30);

    return { day: j_d, month: j_m, year: j_y };
  }

  getPersianMonthDays(year, month) {
    if (month <= 6) return 31;
    if (month <= 11) return 30;
    return this.isLeapYear(year) ? 30 : 29;
  }

  isLeapYear(year) {
    return (year + 2346) % 2820 % 2816 % 128 === 105;
  }

  getPersianMonthName(month) {
    const months = ['ŸÅÿ±Ÿàÿ±ÿØ€åŸÜ', 'ÿßÿ±ÿØ€åÿ®Ÿáÿ¥ÿ™', 'ÿÆÿ±ÿØÿßÿØ', 'ÿ™€åÿ±', 'ŸÖÿ±ÿØÿßÿØ', 'ÿ¥Ÿáÿ±€åŸàÿ±', 
                    'ŸÖŸáÿ±', 'ÿ¢ÿ®ÿßŸÜ', 'ÿ¢ÿ∞ÿ±', 'ÿØ€å', 'ÿ®ŸáŸÖŸÜ', 'ÿßÿ≥ŸÅŸÜÿØ'];
    return months[month - 1];
  }

  renderCalendar() {
    const year = this.currentDate.year;
    const month = this.currentDate.month;
    const monthName = this.getPersianMonthName(month);
    
    document.getElementById('currentMonth').textContent = `${monthName} ${year}`;

    const firstDay = new Date(year, month - 1, 1).getDay();
    const daysInMonth = this.getPersianMonthDays(year, month);
    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';

    const prevMonth = month === 1 ? 12 : month - 1;
    const prevYear = month === 1 ? year - 1 : year;
    const daysInPrevMonth = this.getPersianMonthDays(prevYear, prevMonth);
    const startDay = firstDay === 0 ? 6 : firstDay - 1;
    
    for (let i = daysInPrevMonth - startDay + 1; i <= daysInPrevMonth; i++) {
      const dayEl = document.createElement('div');
      dayEl.className = 'calendar-day other-month';
      dayEl.textContent = i;
      calendarGrid.appendChild(dayEl);
    }

    const today = this.getCurrentPersianDate();
    for (let i = 1; i <= daysInMonth; i++) {
      const dayEl = document.createElement('div');
      dayEl.className = 'calendar-day';
      dayEl.textContent = i;
      
      const dateKey = `${year}-${month}-${i}`;
      
      if (year === today.year && month === today.month && i === today.day) {
        dayEl.classList.add('today');
      }

      if (this.tasks[dateKey]) {
        dayEl.classList.add('has-task');
      }

      dayEl.addEventListener('click', () => this.selectDate(year, month, i, dayEl));
      calendarGrid.appendChild(dayEl);
    }

    const remainingDays = 42 - (calendarGrid.children.length);
    for (let i = 1; i <= remainingDays; i++) {
      const dayEl = document.createElement('div');
      dayEl.className = 'calendar-day other-month';
      dayEl.textContent = i;
      calendarGrid.appendChild(dayEl);
    }
  }

  selectDate(year, month, day, element) {
    document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    this.selectedDate = { year, month, day };
    this.updateSelectedDateDisplay();
  }

  updateSelectedDateDisplay() {
    const display = document.getElementById('selectedDateDisplay');
    if (this.selectedDate) {
      const monthName = this.getPersianMonthName(this.selectedDate.month);
      display.textContent = `Selected: ${monthName} ${this.selectedDate.day}, ${this.selectedDate.year}`;
    }
  }

  setupEventListeners() {
    document.getElementById('prevMonth').addEventListener('click', () => this.previousMonth());
    document.getElementById('nextMonth').addEventListener('click', () => this.nextMonth());
    document.getElementById('addTaskBtn').addEventListener('click', () => this.addTask());
    document.getElementById('taskInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.addTask();
    });
  }

  previousMonth() {
    if (this.currentDate.month === 1) {
      this.currentDate.month = 12;
      this.currentDate.year--;
    } else {
      this.currentDate.month--;
    }
    this.renderCalendar();
  }

  nextMonth() {
    if (this.currentDate.month === 12) {
      this.currentDate.month = 1;
      this.currentDate.year++;
    } else {
      this.currentDate.month++;
    }
    this.renderCalendar();
  }

  addTask() {
    if (!this.selectedDate) {
      alert('Please select a date first');
      return;
    }

    const taskInput = document.getElementById('taskInput');
    const userSelect = document.getElementById('userSelect');
    const taskText = taskInput.value.trim();
    const assignedUser = userSelect.value;

    if (!taskText || !assignedUser) {
      alert('Please enter task and select a user');
      return;
    }

    const dateKey = `${this.selectedDate.year}-${this.selectedDate.month}-${this.selectedDate.day}`;
    if (!this.tasks[dateKey]) {
      this.tasks[dateKey] = [];
    }

    this.tasks[dateKey].push({
      id: Date.now(),
      text: taskText,
      assignedTo: assignedUser,
      completed: false
    });

    localStorage.setItem('adminTasks', JSON.stringify(this.tasks));
    taskInput.value = '';
    userSelect.value = '';
    this.renderCalendar();
    this.renderTasksList();
  }

  renderTasksList() {
    const tasksList = document.getElementById('tasksList');
    tasksList.innerHTML = '';

    let allTasks = [];
    for (const [dateKey, tasks] of Object.entries(this.tasks)) {
      tasks.forEach(task => {
        allTasks.push({ ...task, dateKey });
      });
    }

    if (allTasks.length === 0) {
      tasksList.innerHTML = '<p style="color: #999; text-align: center;">No tasks assigned yet.</p>';
      return;
    }

    allTasks.forEach(task => {
      const [year, month, day] = task.dateKey.split('-');
      const monthName = this.getPersianMonthName(parseInt(month));
      const taskEl = document.createElement('div');
      taskEl.className = `task-item ${task.completed ? 'completed' : ''}`;
      taskEl.innerHTML = `
        <span class="task-text">${task.text}</span>
        <span class="task-date">${monthName} ${day}</span>
        <span class="task-user">üë§ ${task.assignedTo}</span>
        <div class="task-actions">
          <button class="task-btn toggle" onclick="calendarAdmin.toggleTask('${task.dateKey}', ${task.id})">
            ${task.completed ? '‚Ü©' : '‚úì'}
          </button>
          <button class="task-btn delete" onclick="calendarAdmin.deleteTask('${task.dateKey}', ${task.id})">√ó</button>
        </div>
      `;
      tasksList.appendChild(taskEl);
    });
  }

  toggleTask(dateKey, id) {
    const task = this.tasks[dateKey].find(t => t.id === id);
    if (task) {
      task.completed = !task.completed;
      localStorage.setItem('adminTasks', JSON.stringify(this.tasks));
      this.renderTasksList();
    }
  }

  deleteTask(dateKey, id) {
    this.tasks[dateKey] = this.tasks[dateKey].filter(t => t.id !== id);
    if (this.tasks[dateKey].length === 0) {
      delete this.tasks[dateKey];
    }
    localStorage.setItem('adminTasks', JSON.stringify(this.tasks));
    this.renderCalendar();
    this.renderTasksList();
  }
}

// Initialize Persian Calendar for Admin
const calendarAdmin = new PersianCalendarAdmin();
</script>
{% endblock %}


